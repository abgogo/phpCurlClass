<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>Curl 转 PHP</title>
        <link href="http://cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
        <script src="http://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
        <script src="http://cdn.bootcss.com/highlight.js/9.12.0/languages/php.min.js"></script>
        <style>
            pre {
              font: normal 10pt Consolas, Monaco, monospace;
            }
        </style>
    </head>

    <body>
        <div>
            <p>Curl 命令 (Bash):</p>
            <div>
                <textarea rows="5" style="width: 100%;" id="bash"></textarea>
            </div>
            <p><button onclick="convertCurl();">Convert</button></p>
            <p>PHP:</p>
            <div>
                <pre id="php"></pre>
            </div>
        </div>
    </body>

    <script>
        var parse_str = function(str) {
            var strArr = String(str).replace(/^&/, '').replace(/&$/, '').split('&');
            var sal = strArr.length;
            var i;
            var j;
            var ct;
            var p;
            var lastObj;
            var obj;
            var undef;
            var chr;
            var tmp;
            var key;
            var value;
            var postLeftBracketPos;
            var keys;
            var keysLen;
            var array = {};
            var _fixStr = function (str) {
                return decodeURIComponent(str.replace(/\+/g, '%20'));
            };
            var $global = (typeof window !== 'undefined' ? window : global);
            $global.$locutus = $global.$locutus || {};
            var $locutus = $global.$locutus;
            $locutus.php = $locutus.php || {};
            if (!array) {
                array = $global;
            }
            for (i = 0; i < sal; i++) {
                tmp = strArr[i].split('=');
                key = _fixStr(tmp[0]);
                value = (tmp.length < 2) ? '' : _fixStr(tmp[1]);
                while (key.charAt(0) === ' ') {
                    key = key.slice(1);
                }
                if (key.indexOf('\x00') > -1) {
                    key = key.slice(0, key.indexOf('\x00'));
                }
                if (key && key.charAt(0) !== '[') {
                    keys = [];
                    postLeftBracketPos = 0;
                    for (j = 0; j < key.length; j++) {
                        if (key.charAt(j) === '[' && !postLeftBracketPos) {
                            postLeftBracketPos = j + 1;
                        } else if (key.charAt(j) === ']') {
                            if (postLeftBracketPos) {
                                if (!keys.length) {
                                    keys.push(key.slice(0, postLeftBracketPos - 1));
                                }
                                keys.push(key.substr(postLeftBracketPos, j - postLeftBracketPos));
                                postLeftBracketPos = 0;
                                if (key.charAt(j + 1) !== '[') {
                                    break;
                                }
                            }
                        }
                    }
                    if (!keys.length) {
                        keys = [key];
                    }
                    for (j = 0; j < keys[0].length; j++) {
                        chr = keys[0].charAt(j);
                        if (chr === ' ' || chr === '.' || chr === '[') {
                            keys[0] = keys[0].substr(0, j) + '_' + keys[0].substr(j + 1);
                        }
                        if (chr === '[') {
                            break;
                        }
                    }
                    obj = array;
                    for (j = 0, keysLen = keys.length; j < keysLen; j++) {
                        key = keys[j].replace(/^['"]/, '').replace(/['"]$/, '');
                        lastObj = obj;
                        if ((key !== '' && key !== ' ') || j === 0) {
                            if (obj[key] === undef) {
                                obj[key] = {};
                            }
                            obj = obj[key];
                        } else {
                            ct = -1;
                            for (p in obj) {
                                if (obj.hasOwnProperty(p)) {
                                    if (+p > ct && p.match(/^\d+$/g)) {
                                        ct = +p;
                                    }
                                }
                            }
                            key = ct + 1;
                        }
                    }
                    lastObj[key] = value;
                }
            }
            return array;
        };

        var rightPad = function(str, len) {
            return str.length >= ~~len ? str : str + (new Array(~~len - str.length + 1).join(' '));
        };

        var convertCurl = function() {
            var bash = document.getElementById('bash').value.replace(/^curl /, ''),
                arguments = bash.match(/\-.*? (\'.*?\'|[^ ]*)/g),
                headers = {},
                postFields = {},
                url = '',
                op = "$curlObj = CustomCurl::init('__url__'__isPost__)\n";
            
            if (arguments) {
                for (var i = 0; i < arguments.length; i++) {
                    var tmp = arguments[i].match(/(\-)+(.*?) (\'(.*)\'$|[^ ]*)/);
                    switch (tmp[2]) {
                        case 'H':
                            var header = (tmp[4] || tmp[3]).match(/^(.*?): (.*?)$/);
                            switch (header[1]) {
                                case 'Pragma':
                                case 'Origin':
                                case 'Accept-Encoding':
                                case 'Accept-Language':
                                case 'Upgrade-Insecure-Requests':
                                case 'Content-Type':
                                case 'Accept':
                                case 'Cache-Control':
                                case 'Connection':
                                    break;
                                default:
                                    headers[header[1]] = header[2];
                            }
                            break;
                        case 'data':
                            postFields = parse_str(tmp[4] || tmp[3]);
                            break;
                        case 'X':
                            op = op.replace('__isPost__', ", '" + (tmp[4] || tmp[3]).toLowerCase() + "'");
                    }
                    bash = bash.replace(arguments[i], '');
                }
            }
            var urlTmp = bash.match(/\'(http.*?)\'/);
            url = urlTmp[1];

            op = op.replace('__url__', url).replace('__isPost__', JSON.stringify(postFields) === '{}' ? '' : ", 'post'");

            for (var i in headers) {
                switch (i) {
                    case 'User-Agent':
                        op += "            ->set('userAgent', '" + headers[i] + "')\n";
                        break;
                    case 'Referer':
                        op += "            ->set('referer', '" + headers[i] + "')\n";
                        break;
                    case 'Cookie':
                        op += "            ->setCookies('" + headers[i] + "')\n";
                        break;
                    default:
                        op += "            ->setHeader('" + i + "', '" + headers[i] + "')\n";
                }
            }

            if (JSON.stringify(postFields) !== '{}') {
                op += "            ->set('postFields', [\n";
            }

            var getPHPArray = function(f) {
                var opS = '', tabs = arguments[1] || '                ', maxLength = 0;
                for (var i in f) {
                    maxLength = i.length > maxLength ? i.length : maxLength;
                };
                for (var i in f) {
                    if (typeof f[i] === 'object') {
                        opS += tabs + rightPad("'" + i + "'", maxLength + 2) + " => [\n";
                        opS += getPHPArray(f[i], tabs + '    ');
                        opS += tabs + "],\n";
                    } else {
                        opS += tabs + rightPad("'" + i + "'", maxLength + 2) + " => '" + f[i] + "',\n";
                    }
                }
                return opS;
            };

            op += getPHPArray(postFields);

            if (JSON.stringify(postFields) !== '{}') {
                op = op.replace(/,\n( +)\]/g, "\n$1]").replace(/,\n$/, "\n");
                op += "            ])\n";
            }

            document.getElementById('php').innerHTML = op + "            ->exec();\n\nif ($curlObj->getStatus()) {\n    var_dump($curlObj->getHeader(), $curlObj->getCookies(), $curlObj->getBody(), $curlObj->getInfo());\n} else {\n    var_dump($curlObj->getCurlErrNo());\n}";
            hljs.highlightBlock(document.getElementById('php'));
        };
    </script>
</html>